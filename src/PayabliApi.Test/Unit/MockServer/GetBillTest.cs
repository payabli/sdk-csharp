using NUnit.Framework;
using PayabliApi;
using PayabliApi.Core;

namespace PayabliApi.Test.Unit.MockServer;

[TestFixture]
public class GetBillTest : BaseMockServerTest
{
    [NUnit.Framework.Test]
    public async Task MockServerTest()
    {
        const string mockResponse = """
            {
              "responseCode": 1,
              "pageIdentifier": null,
              "roomId": 0,
              "isSuccess": true,
              "responseText": "Success",
              "responseData": {
                "IdBill": 285,
                "BillNumber": "ABC-123",
                "NetAmount": 100,
                "Discount": null,
                "TotalAmount": 100,
                "BillDate": "2025-07-01",
                "DueDate": "2025-07-01",
                "Comments": "Deposit for materials",
                "BatchNumber": null,
                "BillItems": [
                  {
                    "itemTotalAmount": 123,
                    "itemTaxAmount": 7,
                    "itemTaxRate": 0.075,
                    "itemProductCode": "M-DEPOSIT",
                    "itemProductName": "Materials deposit",
                    "itemDescription": "Deposit for materials.",
                    "itemCommodityCode": "010",
                    "itemUnitOfMeasure": "SqFt",
                    "itemCost": 5,
                    "itemQty": 1,
                    "itemMode": 0,
                    "itemCategories": null
                  }
                ],
                "Mode": 0,
                "PaymentMethod": null,
                "PaymentId": null,
                "AccountingField1": "MyInternalId",
                "AccountingField2": "MyInternalId",
                "Terms": null,
                "Source": null,
                "AdditionalData": null,
                "Vendor": {
                  "VendorNumber": "1234",
                  "Name1": "Herman's Coatings and Masonry",
                  "Name2": "",
                  "EIN": "XXXX6789",
                  "Phone": "5555555555",
                  "Email": "contact@hermanscoatings.com",
                  "RemitEmail": null,
                  "Address1": "123 Ocean Drive",
                  "Address2": "Suite 400",
                  "City": "Miami",
                  "State": "FL",
                  "Zip": "33139",
                  "Country": "US",
                  "Mcc": "7777",
                  "LocationCode": "MIA123",
                  "Contacts": [
                    {
                      "ContactName": "Herman Martinez",
                      "ContactEmail": "herman@hermanscoatings.com",
                      "ContactTitle": "Owner",
                      "ContactPhone": "3055550000"
                    }
                  ],
                  "BillingData": {
                    "id": 123,
                    "accountId": null,
                    "nickname": "Checking Account",
                    "bankName": "Country Bank",
                    "routingAccount": "123123123",
                    "accountNumber": "1XXXXXX3123",
                    "typeAccount": "Checking",
                    "bankAccountHolderName": "Gruzya Adventure Outfitters LLC",
                    "bankAccountHolderType": "Business",
                    "bankAccountFunction": 0,
                    "verified": true,
                    "status": 1,
                    "services": [],
                    "default": true
                  },
                  "PaymentMethod": "vcard",
                  "VendorStatus": 1,
                  "VendorId": 1234,
                  "EnrollmentStatus": null,
                  "Summary": {
                    "ActiveBills": 5,
                    "PendingBills": 2,
                    "InTransitBills": 1,
                    "PaidBills": 10,
                    "OverdueBills": 0,
                    "ApprovedBills": 3,
                    "DisapprovedBills": 0,
                    "TotalBills": 21,
                    "ActiveBillsAmount": 1500,
                    "PendingBillsAmount": 500,
                    "InTransitBillsAmount": 200,
                    "PaidBillsAmount": 3000,
                    "OverdueBillsAmount": 0,
                    "ApprovedBillsAmount": 800,
                    "DisapprovedBillsAmount": 0,
                    "TotalBillsAmount": 6000
                  },
                  "PaypointLegalname": "Gruzya Adventure Outfitters LLC",
                  "PaypointDbaname": "Gruzya Adventure Outfitters",
                  "PaypointEntryname": "41035afaa7",
                  "ParentOrgName": "Pilgrim Planner",
                  "ParentOrgId": 1232,
                  "CreatedDate": "2022-07-01T15:00:01.000Z",
                  "LastUpdated": "2022-07-01T15:00:01.000Z",
                  "remitAddress1": "123 Walnut Street",
                  "remitAddress2": "Suite 900",
                  "remitCity": "Miami",
                  "remitState": "FL",
                  "remitZip": "31113",
                  "remitCountry": "US",
                  "payeeName1": "Herman Martinez",
                  "payeeName2": "",
                  "customField1": "",
                  "customField2": "",
                  "customerVendorAccount": "A-37622",
                  "InternalReferenceId": 123,
                  "additionalData": {
                    "customField": "Custom Value 1",
                    "reference": "REF-12345",
                    "notes": "Additional vendor information"
                  },
                  "externalPaypointID": "ext123",
                  "StoredMethods": []
                },
                "Status": -99,
                "CreatedAt": "2025-07-01T15:00:01.000Z",
                "EndDate": null,
                "LastUpdated": "2025-07-01T15:00:01.000Z",
                "Frequency": null,
                "billEvents": [
                  {
                    "description": "Created Bill",
                    "eventTime": "2025-07-01T15:00:01.000Z",
                    "refData": "REF-12345",
                    "extraData": null,
                    "source": "API"
                  }
                ],
                "billApprovals": null,
                "PaypointLegalname": "Gruzya Adventure Outfitters LLC",
                "PaypointDbaname": "Gruzya Adventure Outfitters",
                "ParentOrgId": 1232,
                "ParentOrgName": "Pilgrim Planner",
                "PaypointEntryname": "41035afaa7",
                "paylinkId": null,
                "DocumentsRef": {
                  "zipfile": "documents_285.zip",
                  "filelist": [
                    {
                      "originalName": "invoice.pdf",
                      "zipName": "0_invoice.pdf",
                      "descriptor": "Invoice document"
                    }
                  ]
                },
                "externalPaypointID": null,
                "LotNumber": "LOT-285",
                "EntityID": null
              }
            }
            """;

        Server
            .Given(WireMock.RequestBuilders.Request.Create().WithPath("/Bill/285").UsingGet())
            .RespondWith(
                WireMock
                    .ResponseBuilders.Response.Create()
                    .WithStatusCode(200)
                    .WithBody(mockResponse)
            );

        var response = await Client.Bill.GetBillAsync(285);
        Assert.That(
            response,
            Is.EqualTo(JsonUtils.Deserialize<GetBillResponse>(mockResponse)).UsingDefaults()
        );
    }
}
