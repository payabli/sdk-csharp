using NUnit.Framework;
using PayabliApi;
using PayabliApi.Core;

namespace PayabliApi.Test.Unit.MockServer;

[TestFixture]
public class GetCustomerTest : BaseMockServerTest
{
    [NUnit.Framework.Test]
    public async Task MockServerTest()
    {
        const string mockResponse = """
            {
              "customerId": 4440,
              "customerNumber": "3456-7645A",
              "customerUsername": "myusername",
              "customerStatus": 1,
              "Company": "AA LLC",
              "Firstname": "John",
              "Lastname": "Smith",
              "Phone": "1234567890",
              "Email": "example@email.com",
              "Address": "3245 Main St",
              "Address1": "STE 900",
              "City": "Miami",
              "State": "FL",
              "Zip": "77777",
              "Country": "US",
              "ShippingAddress": "123 Walnut St",
              "ShippingAddress1": "STE 900",
              "ShippingCity": "Johnson City",
              "ShippingState": "TN",
              "ShippingZip": "37619",
              "ShippingCountry": "US",
              "Balance": 1.1,
              "TimeZone": -5,
              "MFA": false,
              "MFAMode": 0,
              "snProvider": "facebook",
              "snIdentifier": "6677fgttyudd999",
              "snData": "",
              "LastUpdated": "2021-06-16T05:00:00.000Z",
              "Created": "2021-06-10T05:00:00.000Z",
              "AdditionalFields": {
                "property1": "string",
                "property2": "string"
              },
              "IdentifierFields": [
                "email"
              ],
              "Subscriptions": [
                {
                  "CreatedAt": "2022-07-01T15:00:01.000Z",
                  "EndDate": "2025-10-19T00:00:00.000Z",
                  "EntrypageId": 0,
                  "ExternalPaypointID": "Paypoint-100",
                  "FeeAmount": 3,
                  "Frequency": "monthly",
                  "IdSub": 396,
                  "LastRun": "2025-10-19T00:00:00.000Z",
                  "LastUpdated": "2022-07-01T15:00:01.000Z",
                  "LeftCycles": 15,
                  "Method": "card",
                  "NetAmount": 3762.87,
                  "NextDate": "2025-10-19T00:00:00.000Z",
                  "ParentOrgName": "PropertyManager Pro",
                  "PaymentData": {
                    "paymentDetails": {
                      "totalAmount": 100
                    }
                  },
                  "PaypointDbaname": "Sunshine Gutters",
                  "PaypointEntryname": "d193cf9a46",
                  "PaypointId": 255,
                  "PaypointLegalname": "Sunshine Services, LLC",
                  "PlanId": 0,
                  "Source": "api",
                  "StartDate": "2025-10-19T00:00:00.000Z",
                  "SubEvents": [
                    {
                      "description": "TransferCreated",
                      "eventTime": "2023-07-05T22:31:06.000Z"
                    }
                  ],
                  "SubStatus": 1,
                  "TotalAmount": 103,
                  "TotalCycles": 24,
                  "UntilCancelled": true
                }
              ],
              "StoredMethods": [
                {
                  "bin": "411111",
                  "binData": {
                    "binMatchedLength": "6",
                    "binCardBrand": "Visa",
                    "binCardType": "Credit",
                    "binCardCategory": "PLATINUM",
                    "binCardIssuer": "Bank of Example",
                    "binCardIssuerCountry": "United States",
                    "binCardIssuerCountryCodeA2": "US",
                    "binCardIssuerCountryNumber": "840",
                    "binCardIsRegulated": "false",
                    "binCardUseCategory": "Consumer",
                    "binCardIssuerCountryCodeA3": "USA"
                  },
                  "descriptor": "visa",
                  "expDate": "1227",
                  "holderName": "Chad Mercia",
                  "idPmethod": "6edcbb56-9c0e-4003-b3d1-99abf149ba0e",
                  "lastUpdated": "2022-07-01T15:00:01.000Z",
                  "maskedAccount": "4XXXXXXXX1111",
                  "method": "card"
                }
              ],
              "customerSummary": {
                "numberofTransactions": 30,
                "recentTransactions": [
                  {
                    "EntrypageId": 0,
                    "FeeAmount": 1,
                    "PayorId": 1551,
                    "PaypointId": 226,
                    "SettlementStatus": 2,
                    "TotalAmount": 30.22,
                    "TransStatus": 1
                  }
                ],
                "totalAmountTransactions": 1500,
                "totalNetAmountTransactions": 1500
              },
              "PaypointLegalname": "Sunshine Services, LLC",
              "PaypointDbaname": "Sunshine Gutters",
              "ParentOrgName": "PropertyManager Pro",
              "ParentOrgId": 123,
              "PaypointEntryname": "d193cf9a46",
              "pageidentifier": "null",
              "externalPaypointID": "Paypoint-100",
              "customerConsent": {
                "eCommunication": {
                  "status": 1,
                  "updatedAt": "2022-07-01T15:00:01.000Z"
                },
                "sms": {
                  "status": 1,
                  "updatedAt": "2022-07-01T15:00:01.000Z"
                }
              }
            }
            """;

        Server
            .Given(WireMock.RequestBuilders.Request.Create().WithPath("/Customer/998").UsingGet())
            .RespondWith(
                WireMock
                    .ResponseBuilders.Response.Create()
                    .WithStatusCode(200)
                    .WithBody(mockResponse)
            );

        var response = await Client.Customer.GetCustomerAsync(998);
        Assert.That(
            response,
            Is.EqualTo(JsonUtils.Deserialize<CustomerQueryRecords>(mockResponse)).UsingDefaults()
        );
    }
}
